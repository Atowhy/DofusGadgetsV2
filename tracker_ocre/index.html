<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traqueur de Qu√™te du Dofus Ocre</title>
    <link rel="icon" type="image/png" href="../images/LogoDGv1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* Styles globaux h√©rit√©s de votre exemple */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 - fallback if video fails */
            color: #e2e8f0; /* Light text */
            min-height: 100vh; /* Ensure body takes full height */
            margin: 0; /* Remove default body margin */
            padding: 0; /* Remove default body padding */
            -webkit-font-smoothing: antialiased;
            -moz-osx-smoothing: grayscale;
        }
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -2;
        }
        .video-background video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }
        .card-bg {
            background-color: rgba(31, 41, 55, 0.85); /* bg-gray-800 with 85% opacity */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .placeholder-custom::placeholder {
            color: #9ca3af;
        }
        .tab-active {
            border-color: #14b8a6; /* teal-500 */
            color: #14b8a6; /* teal-500 */
            background-color: rgba(20, 184, 166, 0.1);
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #4b5563; /* border-gray-600 */
            border-bottom-color: #14b8a6; /* teal-500 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles sp√©cifiques au traqueur Ocre */
        .monster-card {
            background-color: rgba(31, 41, 55, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative; /* Pour l'aura */
            overflow: hidden; /* Pour contenir l'aura si elle d√©passe */
        }
        .monster-card.captured {
            opacity: 0.6;
            filter: grayscale(100%);
            border-color: #4b5563; /* gray-600 */
        }
        .monster-card.captured .toggle-captured-btn {
            background-color: #10b981; /* emerald-500 */
        }

        /* Styles d'aura pour les archimonstres */
        .monster-card.archimonstre-highlight {
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            border-color: #FFD700; /* Gold */
        }
        /* Styles d'aura pour les boss */
        .monster-card.boss-highlight {
            box-shadow: 0 0 10px rgba(220, 20, 60, 0.5), 0 0 20px rgba(220, 20, 60, 0.3);
            border-color: #DC143C; /* Crimson */
        }

        /* Style pour les tags de zone cliquables */
        .zone-tag {
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }
        .zone-tag:hover {
            color: #4fd1c5; /* teal-300 lighter on hover */
        }
        /* Style pour la pagination pour g√©rer le d√©bordement */
        .pagination-container-wrapper {
            overflow-x: auto; /* Permet le d√©filement horizontal si trop de boutons */
            padding-bottom: 8px; /* Pour √©viter que le scrollbar ne cache les boutons */
        }
        .pagination-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: nowrap; /* Emp√™che les boutons de passer √† la ligne */
            gap: 8px; /* Espacement entre les boutons */
            min-width: fit-content; /* S'assure que le contenu ne se r√©duit pas */
        }
        /* Styles pour la barre de progression dans les options de filtre d'√©tape */
        .stage-progress-bar-container {
            width: 60px; /* Largeur fixe pour la barre */
            height: 6px;
            background-color: #4b5563; /* bg-gray-600 */
            border-radius: 3px;
            overflow: hidden;
            display: inline-block; /* Pour aligner avec le texte */
            vertical-align: middle;
            margin-left: 8px; /* Espacement du texte */
        }
        .stage-progress-bar-fill {
            height: 100%;
            background-color: #14b8a6; /* teal-500 */
            border-radius: 3px;
            transition: width 0.3s ease-in-out;
        }
        .stage-progress-bar-fill.golden {
            background-color: #FFD700; /* Gold */
        }

        /* Styles pour la nouvelle section de progression par √©tapes et zones */
        .summary-card { /* Classe g√©n√©rique pour les cartes de r√©sum√© */
            background-color: rgba(31, 41, 55, 0.85); /* bg-gray-800 avec opacit√© */
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer; /* Rendre la carte cliquable */
            transition: transform 0.2s ease-in-out;
        }
        .summary-card:hover {
            transform: translateY(-5px); /* Effet de survol */
        }
        .summary-bar-container { /* Classe g√©n√©rique pour les conteneurs de barre */
            width: 100%;
            height: 8px;
            background-color: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .summary-bar-fill { /* Classe g√©n√©rique pour les barres de remplissage */
            height: 100%;
            background-color: #14b8a6; /* teal-500 */
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
        }
        .summary-bar-fill.golden {
            background-color: #FFD700; /* Gold */
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="text-white antialiased">
    <!-- Conteneur de la vid√©o d'arri√®re-plan -->
    <div class="video-background">
        <video autoplay loop muted playsinline>
            <source src="/images/CorruLoop.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <!-- Superposition pour une meilleure lisibilit√© du texte sur la vid√©o -->
    <div class="video-overlay"></div>

    <div class="relative z-10 container mx-auto p-4 md:p-8 max-w-4xl min-h-screen flex flex-col">
        
        <div class="flex justify-between items-center mb-4">
            <a href="https://dofusgadgets.com" class="text-teal-400 hover:text-teal-300" data-translate-key="btn_back_home">&larr; Retour √† l'accueil</a>
            <select id="language-selector" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                <option value="fr">üá´üá∑ Fran√ßais</option>
                <option value="en">üá¨üáß English</option>
            </select>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-400" data-translate-key="main_title_ocre">Traqueur de Qu√™te du Dofus Ocre</h1>
            <p class="text-gray-400 mt-2" data-translate-key="subtitle_ocre">Suivez votre progression dans l'√âternelle Moisson.</p>
        </header>

        <div class="mb-6">
            <div class="border-b border-gray-700">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="tab-monster-list" class="tab-btn tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-translate-key="tab_monster_list">
                        Liste des Monstres
                    </button>
                    <button id="tab-stage-progress" class="tab-btn text-gray-400 hover:text-teal-300 whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-lg" data-translate-key="tab_stage_progress">
                        Progression par √âtapes
                    </button>
                    <button id="tab-zone-progress" class="tab-btn text-gray-400 hover:text-teal-300 whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-lg" data-translate-key="tab_zone_progress">
                        Progression par Zones
                    </button>
                </nav>
            </div>
        </div>


        <!-- Contenu de l'onglet "Liste des Monstres" -->
        <div id="content-monster-list">
            <div class="card-bg p-6 rounded-2xl shadow-lg mb-8">
                <div class="relative flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white" data-translate-key="progress_summary">R√©sum√© de la Progression</h2>
                    <div id="data-actions-container" class="relative">
                        <button id="data-actions-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500" aria-label="Gestion des donn√©es">
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <div id="data-actions-dropdown" class="hidden absolute right-0 mt-2 w-56 card-bg rounded-lg shadow-xl z-20 py-1">
                            <a href="#" id="dropdown-import-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600 hover:text-white transition-colors" data-translate-key="btn_import">Importer</a>
                            <a href="#" id="dropdown-import-mopolo-btn" class="block px-4 py-2 text-sm text-yellow-400 hover:bg-yellow-600 hover:text-white transition-colors" data-translate-key="btn_import_mopolo">Importer (Mopolo)</a>
                            <a href="#" id="dropdown-export-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-600 hover:text-white transition-colors" data-translate-key="btn_export">Exporter</a>
                            <a href="#" id="dropdown-reset-btn" class="block px-4 py-2 text-sm text-red-400 hover:bg-red-700 hover:text-white transition-colors" data-translate-key="btn_reset">R√©initialiser</a>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                    <!-- Progression globale -->
                    <div class="md:col-span-2 lg:col-span-4">
                        <p class="text-sm text-gray-400" data-translate-key="overall_progress">Total</p>
                        <p id="overall-count" class="text-2xl font-bold text-teal-300">0 / 0 (0%)</p>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                            <div id="overall-progress-bar" class="bg-teal-500 h-2.5 rounded-full" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Barres de progression par cat√©gorie -->
                    <div>
                        <p class="text-sm text-gray-400" data-translate-key="monsters_category">Monstres</p>
                        <p id="monsters-count" class="text-xl font-bold text-teal-300">0 / 0 (0%)</p>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="monsters-progress-bar" class="bg-teal-500 h-2 rounded-full" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400" data-translate-key="bosses_category">Boss</p>
                        <p id="bosses-count" class="text-xl font-bold text-teal-300">0 / 0 (0%)</p>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="bosses-progress-bar" class="bg-teal-500 h-2 rounded-full" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400" data-translate-key="archimonsters_category">Archimonstres</p>
                        <p id="archimonsters-count" class="text-xl font-bold text-teal-300">0 / 0 (0%)</p>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="archimonsters-progress-bar" class="bg-teal-500 h-2 rounded-full" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400" data-translate-key="stages_category">√âtapes</p>
                        <p id="stages-count" class="text-xl font-bold text-teal-300">0 / 0 (0%)</p>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="stages-progress-bar" class="bg-teal-500 h-2 rounded-full" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 flex-wrap">
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto flex-wrap">
                        <input type="search" id="search-input" class="w-full md:w-auto bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom" data-translate-key-placeholder="placeholder_search" placeholder="Rechercher un monstre...">
                        <select id="type-filter" class="w-full md:w-auto bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            <option value="all" data-translate-key="filter_all">Tous les types</option>
                            <option value="monstre" data-translate-key="filter_monstre">Monstres</option>
                            <option value="boss" data-translate-key="filter_boss">Boss</option>
                            <option value="archimonstre" data-translate-key="filter_archimonstre">Archimonstres</option>
                        </select>
                        <select id="zone-filter" class="w-full md:w-auto bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            <option value="all" data-translate-key="filter_all_zones">Toutes les zones</option>
                            <!-- Les options de zone seront ajout√©es dynamiquement ici -->
                        </select>
                        <select id="stage-filter" class="w-full md:w-auto bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            <option value="all" data-translate-key="filter_all_stages">Toutes les √©tapes</option>
                            <!-- Les options d'√©tape seront ajout√©es dynamiquement ici -->
                        </select>
                    </div>
                    <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                        <input type="checkbox" id="hide-captured-monsters" class="form-checkbox h-5 w-5 text-teal-600 transition duration-150 ease-in-out rounded-md focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">
                        <span data-translate-key="hide_captured_monsters">Masquer les monstres captur√©s</span>
                    </label>
                </div>
                <div id="monster-list-container" class="space-y-3">
                    <p id="empty-message" class="text-center text-gray-500 py-8" data-translate-key="empty_list">Chargement des monstres...</p>
                </div>
                <div class="pagination-container-wrapper">
                    <div id="pagination-container" class="pagination-buttons mt-6"></div>
                </div>
            </div>
        </div>

        <!-- Contenu de l'onglet "Progression par √âtapes" -->
        <div id="content-stage-progress" class="hidden">
            <div class="card-bg p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white" data-translate-key="detailed_stage_progress">Progression par √âtapes</h2>
                    <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                        <input type="checkbox" id="hide-completed-stages" class="form-checkbox h-5 w-5 text-teal-600 transition duration-150 ease-in-out rounded-md focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">
                        <span data-translate-key="hide_completed_stages">Masquer les √©tapes termin√©es</span>
                    </label>
                </div>
                <div id="detailed-stage-progress-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Les √©tapes d√©taill√©es seront rendues ici -->
                    <p id="empty-stage-progress" class="text-center text-gray-500 col-span-full" data-translate-key="empty_stage_progress">Chargement des √©tapes...</p>
                </div>
            </div>
        </div>

        <!-- Contenu de l'onglet "Progression par Zones" -->
        <div id="content-zone-progress" class="hidden">
            <div class="card-bg p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white" data-translate-key="detailed_zone_progress">Progression par Zones</h2>
                    <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                        <input type="checkbox" id="hide-completed-zones" class="form-checkbox h-5 w-5 text-teal-600 transition duration-150 ease-in-out rounded-md focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">
                        <span data-translate-key="hide_completed_zones">Masquer les zones termin√©es</span>
                    </label>
                </div>
                <div id="detailed-zone-progress-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Les zones d√©taill√©es seront rendues ici -->
                    <p id="empty-zone-progress" class="text-center text-gray-500 col-span-full" data-translate-key="empty_zone_progress">Chargement des zones...</p>
                </div>
            </div>
        </div>
        
        <!-- Modal for Import/Export -->
        <div id="data-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="card-bg p-6 rounded-2xl shadow-lg w-full max-w-md">
                <h2 id="modal-title" class="text-xl font-semibold mb-2 text-white"></h2>
                <p id="modal-description" class="text-gray-400 mb-4 text-sm"></p>
                <textarea id="data-code-textarea" class="w-full h-32 bg-gray-900 border border-gray-600 rounded-lg p-2 text-white font-mono text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition placeholder-custom" placeholder="..."></textarea>
                <div class="flex flex-wrap gap-4 mt-4 justify-end">
                    <button id="copy-code-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md" data-translate-key="btn_copy">Copier</button>
                    <button id="import-code-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md" data-translate-key="btn_import_code">Importer ce code</button>
                    <button id="close-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-md" data-translate-key="btn_close">Fermer</button>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-auto pt-12 pb-4">
            <img src="https://placehold.co/48x48/111827/e2e8f0?text=Dofus" alt="Logo Dofus" class="h-12 mx-auto mb-2 opacity-50">
            <p data-translate-key="signature">Apps by Ato</p>
            <p class="text-xs text-gray-600 mt-4" data-translate-key="disclaimer">Dofus et toutes les images associ√©es utilis√©es sur ce site sont la propri√©t√© d'Ankama</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const translations = {
                fr: {
                    btn_back_home: "‚Üê Retour √† l'accueil",
                    main_title_ocre: "Traqueur de Qu√™te du Dofus Ocre",
                    subtitle_ocre: "Suivez votre progression dans l'√âternelle Moisson.",
                    tab_monster_list: "Liste des Monstres",
                    tab_stage_progress: "Progression par √âtapes",
                    tab_zone_progress: "Progression par Zones",
                    progress_summary: "R√©sum√© de la Progression",
                    overall_progress: "Total",
                    monsters_category: "Monstres",
                    bosses_category: "Boss",
                    archimonsters_category: "Archimonstres",
                    stages_category: "√âtapes",
                    detailed_stage_progress: "Progression par √âtapes",
                    detailed_zone_progress: "Progression par Zones",
                    empty_stage_progress: "Aucune √©tape √† afficher.",
                    empty_zone_progress: "Aucune zone √† afficher.",
                    placeholder_search: "Rechercher un monstre...",
                    filter_all: "Tous les types",
                    filter_monstre: "Monstres",
                    filter_boss: "Boss",
                    filter_archimonstre: "Archimonstres",
                    filter_all_zones: "Toutes les zones",
                    filter_all_stages: "Toutes les √©tapes",
                    empty_list: "Aucun monstre trouv√©.",
                    toggle_captured: "Capturer",
                    toggle_uncaptured: "Annuler",
                    hide_captured_monsters: "Masquer les monstres captur√©s",
                    hide_completed_stages: "Masquer les √©tapes termin√©es",
                    hide_completed_zones: "Masquer les zones termin√©es",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus et toutes les images associ√©es utilis√©es sur ce site sont la propri√©t√© d'Ankama",
                    stage: "√âtape",
                    zone: "Zone",
                    type: "Type",
                    pagination_prev: "Pr√©c.",
                    pagination_next: "Suiv.",
                    data_management: "Gestion des Donn√©es",
                    btn_import: "Importer",
                    btn_import_mopolo: "Importer (Mopolo)",
                    btn_export: "Exporter",
                    btn_reset: "R√©initialiser",
                    modal_title_export: "Exporter votre progression",
                    modal_desc_export: "Copiez ce code pour sauvegarder votre progression. Vous pourrez l'importer plus tard sur n'importe quel appareil.",
                    modal_title_import: "Importer votre progression",
                    modal_desc_import: "Collez un code de sauvegarde dans la zone ci-dessous et cliquez sur 'Importer' pour restaurer votre progression.",
                    modal_title_import_mopolo: "Importer une sauvegarde Mopolo",
                    modal_desc_import_mopolo: "Collez votre liste de nombres (s√©par√©s par des virgules) export√©e depuis mopolo.dev pour charger votre progression.",
                    modal_placeholder: "Votre code de sauvegarde...",
                    modal_placeholder_mopolo: "Ex: 627,288,370,208,...",
                    btn_copy: "Copier",
                    btn_import_code: "Importer ce code",
                    btn_close: "Fermer",
                    alert_copied: "Code copi√© dans le presse-papiers !",
                    alert_import_success: "Progression import√©e avec succ√®s !",
                    alert_import_error: "Erreur : Le code de sauvegarde est invalide ou corrompu.",
                    alert_import_mopolo_error: "Erreur : La liste de nombres est invalide ou ne contient aucun monstre valide.",
                    alert_reset_confirm_1: "√ätes-vous s√ªr de vouloir r√©initialiser toute votre progression ? Cette action est irr√©versible.",
                    alert_reset_confirm_2: "Dernier avertissement : Toutes vos donn√©es de capture seront d√©finitivement effac√©es. Continuer ?",
                    alert_reset_success: "Votre progression a √©t√© r√©initialis√©e."
                },
                en: {
                    btn_back_home: "‚Üê Back to Home",
                    main_title_ocre: "Dofus Ocre Quest Tracker",
                    subtitle_ocre: "Track your progress in the Eternal Harvest quest.",
                    tab_monster_list: "Monster List",
                    tab_stage_progress: "Stage Progress",
                    tab_zone_progress: "Zone Progress",
                    progress_summary: "Progress Summary",
                    overall_progress: "Total",
                    monsters_category: "Monsters",
                    bosses_category: "Bosses",
                    archimonsters_category: "Archimonsters",
                    stages_category: "Stages",
                    detailed_stage_progress: "Progress by Stages",
                    detailed_zone_progress: "Progress by Zones",
                    empty_stage_progress: "No stages to display.",
                    empty_zone_progress: "No zones to display.",
                    placeholder_search: "Search for a monster...",
                    filter_all: "All Types",
                    filter_monstre: "Monsters",
                    filter_boss: "Bosses",
                    filter_archimonstre: "Archimonsters",
                    filter_all_zones: "All Zones",
                    filter_all_stages: "All Stages",
                    empty_list: "No monsters found.",
                    toggle_captured: "Capture",
                    toggle_uncaptured: "Cancel",
                    hide_captured_monsters: "Hide captured monsters",
                    hide_completed_stages: "Hide completed stages",
                    hide_completed_zones: "Hide completed zones",
                    signature: "Apps by Ato",
                    disclaimer: "Dofus and any related images used on this website are the properties of Ankama",
                    stage: "Stage",
                    zone: "Zone",
                    type: "Type",
                    pagination_prev: "Prev",
                    pagination_next: "Next",
                    data_management: "Data Management",
                    btn_import: "Import",
                    btn_import_mopolo: "Import (Mopolo)",
                    btn_export: "Export",
                    btn_reset: "Reset",
                    modal_title_export: "Export Your Progress",
                    modal_desc_export: "Copy this code to back up your progress. You can import it later on any device.",
                    modal_title_import: "Import Your Progress",
                    modal_desc_import: "Paste a backup code into the text area below and click 'Import' to restore your progress.",
                    modal_title_import_mopolo: "Import Mopolo Save",
                    modal_desc_import_mopolo: "Paste your list of numbers (separated by commas) exported from the mopolo.dev website to load your progress.",
                    modal_placeholder: "Your backup code...",
                    modal_placeholder_mopolo: "E.g. 627,288,370,208,...",
                    btn_copy: "Copy",
                    btn_import_code: "Import this code",
                    btn_close: "Close",
                    alert_copied: "Code copied to clipboard!",
                    alert_import_success: "Progress imported successfully!",
                    alert_import_error: "Error: The backup code is invalid or corrupted.",
                    alert_import_mopolo_error: "Error: The list of numbers is invalid or contains no valid monsters.",
                    alert_reset_confirm_1: "Are you sure you want to reset all your progress? This action cannot be undone.",
                    alert_reset_confirm_2: "Final warning: All your captured data will be permanently deleted. Continue?",
                    alert_reset_success: "Your progress has been reset."
                }
            };

            const languageSelector = document.getElementById('language-selector');
            const searchInput = document.getElementById('search-input');
            const typeFilter = document.getElementById('type-filter');
            const zoneFilter = document.getElementById('zone-filter');
            const stageFilter = document.getElementById('stage-filter');
            const monsterListContainer = document.getElementById('monster-list-container');
            const detailedStageProgressContainer = document.getElementById('detailed-stage-progress-container');
            const detailedZoneProgressContainer = document.getElementById('detailed-zone-progress-container');

            // Nouveaux √©l√©ments pour les onglets
            const tabMonsterListBtn = document.getElementById('tab-monster-list');
            const tabStageProgressBtn = document.getElementById('tab-stage-progress');
            const tabZoneProgressBtn = document.getElementById('tab-zone-progress');
            const contentMonsterList = document.getElementById('content-monster-list');
            const contentStageProgress = document.getElementById('content-stage-progress');
            const contentZoneProgress = document.getElementById('content-zone-progress');
            
            // √âl√©ments des filtres de masquage
            const hideCapturedMonstersCheckbox = document.getElementById('hide-captured-monsters');
            const hideCompletedStagesCheckbox = document.getElementById('hide-completed-stages');
            const hideCompletedZonesCheckbox = document.getElementById('hide-completed-zones');

            // √âl√©ments de r√©sum√© de progression
            const overallCountElement = document.getElementById('overall-count');
            const overallProgressBarElement = document.getElementById('overall-progress-bar');
            const monstersCountElement = document.getElementById('monsters-count');
            const monstersProgressBarElement = document.getElementById('monsters-progress-bar');
            const bossesCountElement = document.getElementById('bosses-count');
            const bossesProgressBarElement = document.getElementById('bosses-progress-bar');
            const archimonstersCountElement = document.getElementById('archimonsters-count');
            const archimonstersProgressBarElement = document.getElementById('archimonsters-progress-bar');
            const stagesCountElement = document.getElementById('stages-count');
            const stagesProgressBarElement = document.getElementById('stages-progress-bar');

            const paginationContainer = document.getElementById('pagination-container');
            const emptyMessageElement = document.getElementById('empty-message');

            // √âl√©ments de gestion des donn√©es (modal)
            const dataModal = document.getElementById('data-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalDescription = document.getElementById('modal-description');
            const dataCodeTextarea = document.getElementById('data-code-textarea');
            const copyCodeBtn = document.getElementById('copy-code-btn');
            const importCodeBtn = document.getElementById('import-code-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            // √âl√©ments de gestion des donn√©es (dropdown)
            const dataActionsBtn = document.getElementById('data-actions-btn');
            const dataActionsDropdown = document.getElementById('data-actions-dropdown');
            const dataActionsContainer = document.getElementById('data-actions-container');
            const dropdownImportBtn = document.getElementById('dropdown-import-btn');
            const dropdownImportMopoloBtn = document.getElementById('dropdown-import-mopolo-btn');
            const dropdownExportBtn = document.getElementById('dropdown-export-btn');
            const dropdownResetBtn = document.getElementById('dropdown-reset-btn');

            let currentLanguage = 'fr';
            let allMonsters = [];
            let capturedMonsters = new Set();
            let currentPage = 1;
            const monstersPerPage = 20;

            const MONSTER_IMAGE_BASE_URL = './monster_images/';
            const defaultIconUrl = 'https://placehold.co/64x64/374151/9ca3af?text=?';

            function setLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('dofusOcreLang', lang);
                document.documentElement.lang = lang;
                languageSelector.value = lang;

                document.querySelectorAll('[data-translate-key]').forEach(element => {
                    const key = element.getAttribute('data-translate-key');
                    if (translations[lang] && translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });

                document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-translate-key-placeholder');
                    if (translations[lang] && translations[lang][key]) {
                        element.placeholder = translations[lang][key];
                    }
                });
                document.querySelectorAll('#type-filter option').forEach(option => {
                    option.textContent = translations[lang][`filter_${option.value}`] || option.value;
                });
                document.querySelectorAll('#zone-filter option').forEach(option => {
                    const key = option.getAttribute('data-translate-key');
                    if (translations[lang] && translations[lang][key]) {
                        option.textContent = translations[lang][key];
                    }
                });
                populateStageFilter(Array.from(new Set(allMonsters.map(m => m.etape))).sort((a, b) => a - b));
                populateZoneFilter(Array.from(new Set(allMonsters.flatMap(m => m.zones))).sort());

                renderMonsterList();
                updateProgressSummary();
            }

            function saveCapturedMonsters() {
                localStorage.setItem('dofusOcreCaptured', JSON.stringify(Array.from(capturedMonsters)));
            }

            function loadCapturedMonsters() {
                const saved = localStorage.getItem('dofusOcreCaptured');
                if (saved) {
                    capturedMonsters = new Set(JSON.parse(saved));
                }
            }

            function updateProgressSummary() {
                const totalMonsters = allMonsters.length;
                const currentCaptured = capturedMonsters.size;
                const overallPercentage = totalMonsters > 0 ? Math.round((currentCaptured / totalMonsters) * 100) : 0;
                overallCountElement.textContent = `${currentCaptured} / ${totalMonsters} (${overallPercentage}%)`;
                overallProgressBarElement.style.width = `${overallPercentage}%`;

                const monsters = allMonsters.filter(m => m.type === 'monstre');
                const capturedMonstersCount = monsters.filter(m => capturedMonsters.has(m.id)).length;
                const monstersPercentage = monsters.length > 0 ? Math.round((capturedMonstersCount / monsters.length) * 100) : 0;
                monstersCountElement.textContent = `${capturedMonstersCount} / ${monsters.length} (${monstersPercentage}%)`;
                monstersProgressBarElement.style.width = `${monstersPercentage}%`;

                const bosses = allMonsters.filter(m => m.type === 'boss');
                const capturedBossesCount = bosses.filter(m => capturedMonsters.has(m.id)).length;
                const bossesPercentage = bosses.length > 0 ? Math.round((capturedBossesCount / bosses.length) * 100) : 0;
                bossesCountElement.textContent = `${capturedBossesCount} / ${bosses.length} (${bossesPercentage}%)`;
                bossesProgressBarElement.style.width = `${bossesPercentage}%`;

                const archimonsters = allMonsters.filter(m => m.type === 'archimonstre');
                const capturedArchimonstersCount = archimonsters.filter(m => capturedMonsters.has(m.id)).length;
                const archimonstersPercentage = archimonsters.length > 0 ? Math.round((capturedArchimonstersCount / archimonsters.length) * 100) : 0;
                archimonstersCountElement.textContent = `${capturedArchimonstersCount} / ${archimonsters.length} (${archimonstersPercentage}%)`;
                archimonstersProgressBarElement.style.width = `${archimonstersPercentage}%`;

                const maxStage = allMonsters.reduce((max, m) => Math.max(max, m.etape), 0);
                let completedStages = 0;
                for (let i = 1; i <= maxStage; i++) {
                    const monstersInStage = allMonsters.filter(m => m.etape === i);
                    if (monstersInStage.length > 0 && monstersInStage.every(m => capturedMonsters.has(m.id))) {
                        completedStages++;
                    }
                }
                const stagesPercentage = maxStage > 0 ? Math.round((completedStages / maxStage) * 100) : 0;
                stagesCountElement.textContent = `${completedStages} / ${maxStage} (${stagesPercentage}%)`;
                stagesProgressBarElement.style.width = `${stagesPercentage}%`;

                renderDetailedStageProgress();
                renderDetailedZoneProgress();
            }

            function renderDetailedStageProgress() {
                detailedStageProgressContainer.innerHTML = '';

                const uniqueStages = Array.from(new Set(allMonsters.map(m => m.etape))).sort((a, b) => a - b);

                if (uniqueStages.length === 0) {
                    detailedStageProgressContainer.innerHTML = `<p id="empty-stage-progress" class="text-center text-gray-500 col-span-full" data-translate-key="empty_stage_progress">${translations[currentLanguage].empty_stage_progress}</p>`;
                    return;
                }

                uniqueStages.forEach(stage => {
                    const monstersInStage = allMonsters.filter(m => m.etape === stage);
                    const capturedInStage = monstersInStage.filter(m => capturedMonsters.has(m.id)).length;
                    const totalInStage = monstersInStage.length;
                    const percentage = totalInStage > 0 ? Math.round((capturedInStage / totalInStage) * 100) : 0;

                    if (hideCompletedStagesCheckbox.checked && percentage === 100) {
                        return;
                    }

                    const stageCard = document.createElement('div');
                    stageCard.dataset.stage = stage;
                    stageCard.className = `summary-card p-3 rounded-lg text-center flex flex-col justify-between`;
                    
                    stageCard.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-400">${translations[currentLanguage].stage} ${stage}</p>
                            <p class="text-xl font-bold text-white">${capturedInStage} / ${totalInStage} (${percentage}%)</p>
                        </div>
                        <div class="summary-bar-container">
                            <div class="summary-bar-fill ${percentage === 100 ? 'golden' : ''}" style="width: ${percentage}%;"></div>
                        </div>
                    `;
                    detailedStageProgressContainer.appendChild(stageCard);
                });
            }

            function renderDetailedZoneProgress() {
                detailedZoneProgressContainer.innerHTML = '';

                const uniqueZones = Array.from(new Set(allMonsters.flatMap(m => m.zones))).sort();

                if (uniqueZones.length === 0) {
                    detailedZoneProgressContainer.innerHTML = `<p id="empty-zone-progress" class="text-center text-gray-500 col-span-full" data-translate-key="empty_zone_progress">${translations[currentLanguage].empty_zone_progress}</p>`;
                    return;
                }

                uniqueZones.forEach(zone => {
                    const monstersInZone = allMonsters.filter(m => m.zones.includes(zone));
                    const capturedInZone = monstersInZone.filter(m => capturedMonsters.has(m.id)).length;
                    const totalInZone = monstersInZone.length;
                    const percentage = totalInZone > 0 ? Math.round((capturedInZone / totalInZone) * 100) : 0;

                    if (hideCompletedZonesCheckbox.checked && percentage === 100) {
                        return;
                    }

                    const zoneCard = document.createElement('div');
                    zoneCard.dataset.zone = zone;
                    zoneCard.className = `summary-card p-3 rounded-lg text-center flex flex-col justify-between`;
                    
                    zoneCard.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-400">${translations[currentLanguage].zone}:</p>
                            <p class="text-xl font-bold text-white">${zone}</p>
                            <p class="text-sm text-gray-400">${capturedInZone} / ${totalInZone} (${percentage}%)</p>
                        </div>
                        <div class="summary-bar-container">
                            <div class="summary-bar-fill ${percentage === 100 ? 'golden' : ''}" style="width: ${percentage}%;"></div>
                        </div>
                    `;
                    detailedZoneProgressContainer.appendChild(zoneCard);
                });
            }


            async function fetchMonsterData() {
                emptyMessageElement.textContent = translations[currentLanguage].empty_list; 
                try {
                    const response = await fetch('tracker_ocre_data_v2.json?v=' + new Date().getTime()); 
                    if (!response.ok) {
                        console.error(`Erreur HTTP ! statut : ${response.status} - ${response.statusText}`);
                        throw new Error(`√âchec du chargement de tracker_ocre_data.json. Statut : ${response.status}`);
                    }
                    const data = await response.json(); 
                    
                    const monsterBaseData = new Map();
                    const uniqueZones = new Set();
                    const uniqueStages = new Set();
                    const processedMonsters = [];

                    // Premi√®re passe: collecter les donn√©es des monstres de base (zones et dbID)
                    data.etapes.forEach(stageData => {
                        stageData.monstres.forEach(monster => {
                            if (monster.type !== 'archimonstre') {
                                // FIX: Use lowercase for the key to make matching case-insensitive
                                monsterBaseData.set(monster.nom.toLowerCase(), {
                                    zones: monster.zones || [],
                                    dbID: monster.dbID // Stocker le dbID du monstre de base
                                });
                            }
                        });
                    });

                    // Deuxi√®me passe: construire la liste compl√®te des monstres
                    data.etapes.forEach(stageData => {
                        const stageNumber = stageData.etape;
                        uniqueStages.add(stageNumber);

                        stageData.monstres.forEach(monster => {
                            let monsterZones = [];
                            let imageDbId = monster.dbID; // Par d√©faut, utiliser son propre dbID

                            if (monster.type === 'archimonstre' && monster.base_monster) {
                                // FIX: Use lowercase for lookup to make matching case-insensitive
                                const baseMonster = monsterBaseData.get(monster.base_monster.toLowerCase());
                                if (baseMonster) {
                                    monsterZones = baseMonster.zones;
                                    imageDbId = baseMonster.dbID; // Utiliser le dbID du monstre de base pour l'image
                                }
                            } else {
                                monsterZones = monster.zones || [];
                            }

                            monsterZones.forEach(zone => uniqueZones.add(zone));
                            
                            const imageUrl = `${MONSTER_IMAGE_BASE_URL}${imageDbId}.png`; // Utiliser le dbID d√©termin√©

                            processedMonsters.push({
                                id: monster.id,
                                name: monster.nom,
                                etape: stageNumber, 
                                zones: monsterZones, // Utiliser les zones d√©termin√©es
                                type: monster.type, 
                                icon: imageUrl,
                                dbID: monster.dbID // Conserver le dbID original de l'archimonstre
                            });
                        });
                    });
                    
                    const uniqueProcessedMonsters = Array.from(new Map(processedMonsters.map(monster => [monster.id, monster])).values());

                    allMonsters = uniqueProcessedMonsters;
                    allMonsters.sort((a, b) => a.etape - b.etape || a.name.localeCompare(b.name));

                    populateZoneFilter(Array.from(uniqueZones).sort());
                    populateStageFilter(Array.from(uniqueStages).sort((a, b) => a - b));

                    emptyMessageElement.classList.add('hidden'); 
                    renderMonsterList();
                    updateProgressSummary();

                } catch (error) {
                    console.error('Erreur lors de la r√©cup√©ration ou du traitement des monstres :', error);
                    emptyMessageElement.textContent = `Erreur de chargement des donn√©es : ${error.message}. Veuillez v√©rifier que le fichier 'tracker_ocre_data.json' est bien pr√©sent et correctement format√©.`;
                }
            }

            function populateZoneFilter(zones) {
                zoneFilter.innerHTML = `<option value="all" data-translate-key="filter_all_zones">${translations[currentLanguage].filter_all_zones}</option>`;
                zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone;
                    option.textContent = zone;
                    zoneFilter.appendChild(option);
                });
            }

            function populateStageFilter(stages) {
                stageFilter.innerHTML = `<option value="all" data-translate-key="filter_all_stages">${translations[currentLanguage].filter_all_stages}</option>`;
                stages.forEach(stage => {
                    const monstersInStage = allMonsters.filter(m => m.etape === stage);
                    const capturedInStage = monstersInStage.filter(m => capturedMonsters.has(m.id)).length;
                    const totalInStage = monstersInStage.length;
                    const percentage = totalInStage > 0 ? Math.round((capturedInStage / totalInStage) * 100) : 0;

                    const option = document.createElement('option');
                    option.value = stage;
                    
                    const optionContent = document.createElement('div');
                    optionContent.style.display = 'flex';
                    optionContent.style.alignItems = 'center';
                    optionContent.style.justifyContent = 'space-between';
                    optionContent.style.width = '100%';

                    const textSpan = document.createElement('span');
                    textSpan.textContent = `${translations[currentLanguage].stage} ${stage} (${capturedInStage}/${totalInStage})`;
                    optionContent.appendChild(textSpan);

                    const progressBarContainer = document.createElement('div');
                    progressBarContainer.className = 'stage-progress-bar-container';
                    const progressBarFill = document.createElement('div');
                    progressBarFill.className = `stage-progress-bar-fill ${percentage === 100 ? 'golden' : ''}`;
                    progressBarFill.style.width = `${percentage}%`;
                    progressBarContainer.appendChild(progressBarFill);
                    optionContent.appendChild(progressBarContainer);

                    const fragment = document.createDocumentFragment();
                    fragment.appendChild(optionContent);
                    option.appendChild(fragment);

                    stageFilter.appendChild(option);
                });
            }

            function switchTab(activeTab) {
                contentMonsterList.classList.add('hidden');
                contentStageProgress.classList.add('hidden');
                contentZoneProgress.classList.add('hidden');

                tabMonsterListBtn.classList.remove('tab-active');
                tabStageProgressBtn.classList.remove('tab-active');
                tabZoneProgressBtn.classList.remove('tab-active');

                if (activeTab === 'monster-list') {
                    contentMonsterList.classList.remove('hidden');
                    tabMonsterListBtn.classList.add('tab-active');
                } else if (activeTab === 'stage-progress') {
                    contentStageProgress.classList.remove('hidden');
                    tabStageProgressBtn.classList.add('tab-active');
                    renderDetailedStageProgress();
                } else if (activeTab === 'zone-progress') {
                    contentZoneProgress.classList.remove('hidden');
                    tabZoneProgressBtn.classList.add('tab-active');
                    renderDetailedZoneProgress();
                }
            }

            function renderMonsterList() {
                monsterListContainer.innerHTML = '';
                paginationContainer.innerHTML = '';

                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const selectedZone = zoneFilter.value; 
                const selectedStage = stageFilter.value; 
                const hideCaptured = hideCapturedMonstersCheckbox.checked;

                const filteredMonsters = allMonsters.filter(monster => {
                    const matchesSearch = searchTerm === '' || monster.name.toLowerCase().includes(searchTerm) ||
                                          (monster.zones && monster.zones.some(zone => zone.toLowerCase().includes(searchTerm)));
                    const matchesType = selectedType === 'all' || monster.type === selectedType;
                    const matchesZone = selectedZone === 'all' || (monster.zones && monster.zones.includes(selectedZone));
                    const matchesStage = selectedStage === 'all' || monster.etape === parseInt(selectedStage);
                    
                    const isHiddenByFilter = hideCaptured && capturedMonsters.has(monster.id);

                    return matchesSearch && matchesType && matchesZone && matchesStage && !isHiddenByFilter; 
                });

                if (filteredMonsters.length === 0) {
                    monsterListContainer.innerHTML = `<p class="text-center text-gray-500 py-8">${translations[currentLanguage].empty_list}</p>`;
                    return;
                }

                const totalPages = Math.ceil(filteredMonsters.length / monstersPerPage);
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1;
                }
                const startIndex = (currentPage - 1) * monstersPerPage;
                const endIndex = startIndex + monstersPerPage;
                const paginatedMonsters = filteredMonsters.slice(startIndex, endIndex);

                paginatedMonsters.forEach(monster => {
                    const isCaptured = capturedMonsters.has(monster.id);
                    const card = document.createElement('div');
                    
                    let highlightClass = '';
                    if (monster.type === 'archimonstre') {
                        highlightClass = 'archimonstre-highlight';
                    } else if (monster.type === 'boss') {
                        highlightClass = 'boss-highlight';
                    }

                    card.className = `monster-card p-4 rounded-lg shadow-md flex flex-col md:flex-row items-center justify-between gap-4 transition ${isCaptured ? 'captured' : ''} ${highlightClass}`;

                    const icon = monster.icon || defaultIconUrl;

                    const zoneTagsHtml = monster.zones && monster.zones.length > 0
                        ? monster.zones.map(zone => `<span class="text-teal-300 hover:text-teal-200 cursor-pointer zone-tag" data-zone="${zone}">${zone}</span>`).join(', ')
                        : `<strong class="text-gray-500">N/A</strong>`;

                    card.innerHTML = `
                        <div class="flex items-center gap-4 flex-grow w-full">
                            <img src="${icon}" alt="${monster.name}" class="w-12 h-12 rounded-md bg-gray-700 object-contain" onerror="this.onerror=null; this.src='${defaultIconUrl}'">
                            <div>
                                <p class="text-lg font-semibold text-white">${monster.name}</p>
                                <div class="flex flex-wrap text-sm text-gray-400 mt-1 gap-x-4 gap-y-1">
                                    <span>${translations[currentLanguage].stage}: <strong class="text-gray-200">${monster.etape}</strong></span>
                                    <span>${translations[currentLanguage].zone}: ${zoneTagsHtml}</span>
                                    <span>${translations[currentLanguage].type}: <strong class="text-gray-200">${translations[currentLanguage][monster.type] || monster.type}</strong></span>
                                </div>
                            </div>
                        </div>
                        <button data-id="${monster.id}" class="toggle-captured-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-transform transform hover:scale-105 shadow-md whitespace-nowrap">
                            ${isCaptured ? translations[currentLanguage].toggle_uncaptured : translations[currentLanguage].toggle_captured}
                        </button>
                    `;
                    monsterListContainer.appendChild(card);
                });

                if (totalPages > 1) {
                    const createPaginationButton = (page, text, isDisabled) => {
                        const button = document.createElement('button');
                        button.textContent = text;
                        button.className = `pagination-btn px-4 py-2 rounded-lg transition-colors ${isDisabled ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-600 hover:bg-gray-700 text-white'}`;
                        button.disabled = isDisabled;
                        button.addEventListener('click', () => {
                            currentPage = page;
                            renderMonsterList();
                        });
                        return button;
                    };

                    paginationContainer.appendChild(createPaginationButton(currentPage - 1, translations[currentLanguage].pagination_prev, currentPage === 1));

                    const maxButtonsVisible = 7;
                    let startPage = Math.max(1, currentPage - Math.floor(maxButtonsVisible / 2));
                    let endPage = Math.min(totalPages, startPage + maxButtonsVisible - 1);

                    if (endPage - startPage + 1 < maxButtonsVisible) {
                        startPage = Math.max(1, endPage - maxButtonsVisible + 1);
                    }

                    if (startPage > 1) {
                        paginationContainer.appendChild(createPaginationButton(1, '1', false));
                        if (startPage > 2) {
                            const ellipsisStart = document.createElement('span');
                            ellipsisStart.textContent = '...';
                            ellipsisStart.className = 'px-2 py-2 text-gray-400';
                            paginationContainer.appendChild(ellipsisStart);
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        const button = createPaginationButton(i, i, false);
                        if (i === currentPage) {
                            button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                            button.classList.add('tab-active');
                        }
                        paginationContainer.appendChild(button);
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            const ellipsisEnd = document.createElement('span');
                            ellipsisEnd.textContent = '...';
                            ellipsisEnd.className = 'px-2 py-2 text-gray-400';
                            paginationContainer.appendChild(ellipsisEnd);
                        }
                        paginationContainer.appendChild(createPaginationButton(totalPages, totalPages, false));
                    }

                    paginationContainer.appendChild(createPaginationButton(currentPage + 1, translations[currentLanguage].pagination_next, currentPage === totalPages));
                }
            }
            
            // --- DATA MANAGEMENT FUNCTIONS ---

            function openModal(mode) {
                // Detach listeners first to prevent duplicates
                importCodeBtn.removeEventListener('click', handleImportCode);
                importCodeBtn.removeEventListener('click', handleImportMopoloCode);

                if (mode === 'export') {
                    modalTitle.textContent = translations[currentLanguage].modal_title_export;
                    modalDescription.textContent = translations[currentLanguage].modal_desc_export;
                    dataCodeTextarea.value = btoa(JSON.stringify(Array.from(capturedMonsters)));
                    dataCodeTextarea.readOnly = true;
                    importCodeBtn.classList.add('hidden');
                    copyCodeBtn.classList.remove('hidden');
                } else if (mode === 'import') {
                    modalTitle.textContent = translations[currentLanguage].modal_title_import;
                    modalDescription.textContent = translations[currentLanguage].modal_desc_import;
                    dataCodeTextarea.value = '';
                    dataCodeTextarea.readOnly = false;
                    dataCodeTextarea.placeholder = translations[currentLanguage].modal_placeholder;
                    importCodeBtn.classList.remove('hidden');
                    copyCodeBtn.classList.add('hidden');
                    importCodeBtn.addEventListener('click', handleImportCode);
                } else if (mode === 'import-mopolo') {
                    modalTitle.textContent = translations[currentLanguage].modal_title_import_mopolo;
                    modalDescription.textContent = translations[currentLanguage].modal_desc_import_mopolo;
                    dataCodeTextarea.value = '';
                    dataCodeTextarea.readOnly = false;
                    dataCodeTextarea.placeholder = translations[currentLanguage].modal_placeholder_mopolo;
                    importCodeBtn.classList.remove('hidden');
                    copyCodeBtn.classList.add('hidden');
                    importCodeBtn.addEventListener('click', handleImportMopoloCode);
                }
                dataModal.classList.remove('hidden');
            }

            function closeModal() {
                dataModal.classList.add('hidden');
            }

            function handleReset() {
                if (confirm(translations[currentLanguage].alert_reset_confirm_1)) {
                    if (confirm(translations[currentLanguage].alert_reset_confirm_2)) {
                        capturedMonsters.clear();
                        saveCapturedMonsters();
                        populateStageFilter(Array.from(new Set(allMonsters.map(m => m.etape))).sort((a, b) => a - b));
                        renderMonsterList();
                        updateProgressSummary();
                        alert(translations[currentLanguage].alert_reset_success);
                    }
                }
            }

            function handleCopyCode() {
                navigator.clipboard.writeText(dataCodeTextarea.value).then(() => {
                    alert(translations[currentLanguage].alert_copied);
                });
            }

            function handleImportCode() {
                const code = dataCodeTextarea.value.trim();
                if (!code) return;

                try {
                    const decoded = atob(code);
                    const monsterIds = JSON.parse(decoded);
                    if (!Array.isArray(monsterIds) || !monsterIds.every(id => typeof id === 'number')) {
                        throw new Error('Invalid data format');
                    }

                    capturedMonsters = new Set(monsterIds);
                    saveCapturedMonsters();
                    populateStageFilter(Array.from(new Set(allMonsters.map(m => m.etape))).sort((a, b) => a - b));
                    currentPage = 1;
                    renderMonsterList();
                    updateProgressSummary();
                    alert(translations[currentLanguage].alert_import_success);
                    closeModal();

                } catch (error) {
                    console.error("Import failed:", error);
                    alert(translations[currentLanguage].alert_import_error);
                }
            }

            function handleImportMopoloCode() {
                const code = dataCodeTextarea.value.trim();
                if (!code) return;

                try {
                    const monsterIds = code.split(',')
                                           .map(id => parseInt(id.trim()))
                                           .filter(id => !isNaN(id));
                    
                    const allMonsterIds = new Set(allMonsters.map(m => m.id));
                    const validIds = monsterIds.filter(id => allMonsterIds.has(id));

                    if (validIds.length === 0) {
                         throw new Error('No valid monster IDs found in the provided code.');
                    }

                    capturedMonsters = new Set(validIds);
                    saveCapturedMonsters();
                    populateStageFilter(Array.from(new Set(allMonsters.map(m => m.etape))).sort((a, b) => a - b));
                    currentPage = 1;
                    renderMonsterList();
                    updateProgressSummary();
                    alert(translations[currentLanguage].alert_import_success);
                    closeModal();

                } catch (error) {
                    console.error("Mopolo Import failed:", error);
                    alert(translations[currentLanguage].alert_import_mopolo_error);
                }
            }

            // --- EVENT LISTENERS ---

            monsterListContainer.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('.toggle-captured-btn');
                const zoneTag = e.target.closest('.zone-tag');

                if (toggleBtn) {
                    const monsterId = parseInt(toggleBtn.dataset.id);
                    const selectedStage = stageFilter.value; // Save the current selection

                    if (capturedMonsters.has(monsterId)) {
                        capturedMonsters.delete(monsterId);
                    } else {
                        capturedMonsters.add(monsterId);
                    }
                    saveCapturedMonsters();
                    populateStageFilter(Array.from(new Set(allMonsters.map(m => m.etape))).sort((a, b) => a - b));
                    
                    stageFilter.value = selectedStage; // Restore the selection

                    renderMonsterList();
                    updateProgressSummary();
                } else if (zoneTag) {
                    searchInput.value = '';
                    typeFilter.value = 'all';
                    stageFilter.value = 'all';
                    zoneFilter.value = zoneTag.dataset.zone;
                    currentPage = 1;
                    renderMonsterList();
                    switchTab('monster-list');
                }
            });

            detailedStageProgressContainer.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.summary-card');
                if (clickedCard && clickedCard.dataset.stage) {
                    searchInput.value = '';
                    typeFilter.value = 'all';
                    zoneFilter.value = 'all';
                    stageFilter.value = parseInt(clickedCard.dataset.stage);
                    currentPage = 1;
                    renderMonsterList();
                    switchTab('monster-list');
                }
            });

            detailedZoneProgressContainer.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.summary-card');
                if (clickedCard && clickedCard.dataset.zone) {
                    searchInput.value = '';
                    typeFilter.value = 'all';
                    stageFilter.value = 'all';
                    zoneFilter.value = clickedCard.dataset.zone;
                    currentPage = 1;
                    renderMonsterList();
                    switchTab('monster-list');
                }
            });


            searchInput.addEventListener('input', () => {
                currentPage = 1;
                renderMonsterList();
            });

            typeFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMonsterList();
            });

            zoneFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMonsterList();
            });

            stageFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMonsterList();
            });

            hideCapturedMonstersCheckbox.addEventListener('change', () => {
                currentPage = 1;
                renderMonsterList();
            });

            hideCompletedStagesCheckbox.addEventListener('change', () => {
                renderDetailedStageProgress();
            });

            hideCompletedZonesCheckbox.addEventListener('change', () => {
                renderDetailedZoneProgress();
            });

            tabMonsterListBtn.addEventListener('click', () => switchTab('monster-list'));
            tabStageProgressBtn.addEventListener('click', () => switchTab('stage-progress'));
            tabZoneProgressBtn.addEventListener('click', () => switchTab('zone-progress'));

            languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

            // Data Management Listeners
            dataActionsBtn.addEventListener('click', () => {
                dataActionsDropdown.classList.toggle('hidden');
            });
            
            dropdownImportBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('import');
                dataActionsDropdown.classList.add('hidden');
            });

            dropdownImportMopoloBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('import-mopolo');
                dataActionsDropdown.classList.add('hidden');
            });
            
            dropdownExportBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('export');
                dataActionsDropdown.classList.add('hidden');
            });
            
            dropdownResetBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleReset();
                dataActionsDropdown.classList.add('hidden');
            });
            
            window.addEventListener('click', (e) => {
                if (dataActionsContainer && !dataActionsContainer.contains(e.target)) {
                    dataActionsDropdown.classList.add('hidden');
                }
            });

            closeModalBtn.addEventListener('click', closeModal);
            copyCodeBtn.addEventListener('click', handleCopyCode);
            // The listener for importCodeBtn is now added dynamically in openModal
            dataModal.addEventListener('click', (e) => {
                if (e.target === dataModal) {
                    closeModal();
                }
            });


            // --- INITIALIZATION ---
            const savedLang = localStorage.getItem('dofusOcreLang') || 'fr';
            loadCapturedMonsters();
            fetchMonsterData();
            setLanguage(savedLang);
            switchTab('monster-list');
        });
    </script>

</body>
</html>